#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —ç–ø–∏–∑–æ–¥–æ–≤ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º–∏, –ª–∞–π–∫–∞–º–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
"""
import psycopg2
import os
import random
from typing import List, Tuple

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ DATABASE_URL –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è
DATABASE_URL = os.environ.get('DATABASE_URL')

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∏ –ª–∞–π–∫–æ–≤
def generate_stats(season: int, episode: int) -> Tuple[int, int]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –∏ –ª–∞–π–∫–∏"""
    base_views = random.randint(5000, 25000)
    # –ü–µ—Ä–≤—ã–µ —ç–ø–∏–∑–æ–¥—ã –ø–æ–ø—É–ª—è—Ä–Ω–µ–µ
    if season == 1 and episode <= 3:
        base_views = random.randint(20000, 45000)
    
    likes = int(base_views * random.uniform(0.05, 0.15))
    return base_views, likes

# –ü—É–ª –∏–º—ë–Ω –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
NAMES = [
    "–†–∏–∫ –°-137", "–ú–æ—Ä—Ç–∏ –°–º–∏—Ç", "–°–∞–º–º–µ—Ä", "–î–∂–µ—Ä—Ä–∏", "–ë–µ—Ç",
    "–ü—Ç–∏—á—å—è –õ–∏—á–Ω–æ—Å—Ç—å", "–ú–∏—Å—Ç–µ—Ä –ñ–æ–ø–æ—Å—Ä–∞–Ω—á–∏–∫", "–ú–∏—Å—Ç–µ—Ä –ü–æ–ø–∏–±–∞—Ç—Ç—Ö–æ–ª",
    "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "–î–º–∏—Ç—Ä–∏–π", "–ê–Ω–Ω–∞", "–ï–ª–µ–Ω–∞", "–°–µ—Ä–≥–µ–π", "–û–ª—å–≥–∞",
    "–ú–∞–∫—Å–∏–º", "–ú–∞—Ä–∏—è", "–í–ª–∞–¥–∏–º–∏—Ä", "–ò—Ä–∏–Ω–∞", "–ê–Ω–¥—Ä–µ–π", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞",
    "–ù–∏–∫–æ–ª–∞–π", "–°–≤–µ—Ç–ª–∞–Ω–∞", "–ê–ª–µ–∫—Å–µ–π", "–ù–∞—Ç–∞–ª—å—è", "–ü–∞–≤–µ–ª", "–¢–∞—Ç—å—è–Ω–∞",
    "–ò–≤–∞–Ω", "–Æ–ª–∏—è", "–†–æ–º–∞–Ω", "–í–∏–∫—Ç–æ—Ä–∏—è", "–î–µ–Ω–∏—Å", "–ê–Ω–∞—Å—Ç–∞—Å–∏—è",
    "–ö–∏—Ä–∏–ª–ª", "–î–∞—Ä—å—è", "–ê—Ä—Ç—ë–º", "–ü–æ–ª–∏–Ω–∞", "–ï–≥–æ—Ä", "–í–∞–ª–µ—Ä–∏—è"
]

# –®–∞–±–ª–æ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ–∑–æ–Ω–æ–≤
COMMENT_TEMPLATES = {
    1: [
        "–ü–∏–ª–æ—Ç –ø—Ä–æ—Å—Ç–æ –±–æ–º–±–∞! {} –∏–∑ 5 –∑–≤—ë–∑–¥!",
        "–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ —Å–µ—Ä–∏–∞–ª–∞, —Å—Ä–∞–∑—É –≤–∏–¥–Ω–∞ –≥–µ–Ω–∏–∞–ª—å–Ω–æ—Å—Ç—å –†–∏–∫–∞",
        "–ú–æ—Ä—Ç–∏ –≤ —ç—Ç–æ–π —Å–µ—Ä–∏–∏ –ø—Ä–æ—Å—Ç–æ —à–µ–¥–µ–≤—Ä üòÇ",
        "–í–ø–µ—Ä–≤—ã–µ —É–≤–∏–¥–µ–ª —ç—Ç—É —Å–µ—Ä–∏—é –∏ –Ω–µ –ø–æ–∂–∞–ª–µ–ª",
        "–ö–ª–∞—Å—Å–∏–∫–∞! –ü–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞—é —É–∂–µ {} —Ä–∞–∑",
        "–Æ–º–æ—Ä –Ω–∞ –≤—ã—Å–æ—Ç–µ, –æ–±–æ–∂–∞—é —ç—Ç–æ—Ç —Å–µ—Ä–∏–∞–ª",
        "–ü–æ—Ä—Ç–∞–ª-–ø—É—à–∫–∞ - –ª—É—á—à–µ–µ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ –†–∏–∫–∞!",
        "–≠—Ç–∞ —Å–µ—Ä–∏—è –∑–∞—Å—Ç–∞–≤–∏–ª–∞ –º–µ–Ω—è –≤–ª—é–±–∏—Ç—å—Å—è –≤ —Å–µ—Ä–∏–∞–ª",
        "–ë—Ä–∞–≤–æ —Å–æ–∑–¥–∞—Ç–µ–ª—è–º! –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ –∏ —Å–º–µ—à–Ω–æ",
        "–†–∏–∫ - –º–æ–π –ª—é–±–∏–º—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂, –≥–µ–Ω–∏–π!",
    ],
    2: [
        "–í—Ç–æ—Ä–æ–π —Å–µ–∑–æ–Ω –Ω–µ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–ª!",
        "–°—é–∂–µ—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—Å—ë –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ",
        "–û—Ç–ª–∏—á–Ω–∞—è —Å–µ—Ä–∏—è, {} –∑–≤—ë–∑–¥!",
        "–†–∏–∫ —Å–Ω–æ–≤–∞ –≤—Å–µ—Ö –ø–µ—Ä–µ–∏–≥—Ä–∞–ª üî•",
        "–ú–æ—Ä—Ç–∏ –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –ø–æ–≤–∑—Ä–æ—Å–ª–µ–ª",
        "–û–±–æ–∂–∞—é –º–µ–∂–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è",
        "–õ—É—á—à–∏–π —ç–ø–∏–∑–æ–¥ —Å–µ–∑–æ–Ω–∞!",
        "–°–º–µ—è–ª—Å—è –≤—Å—é —Å–µ—Ä–∏—é üòÑ",
        "–ì–µ–Ω–∏–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π",
        "–¢–∞–∫–æ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞ –Ω–µ –æ–∂–∏–¥–∞–ª!",
    ],
    3: [
        "–¢—Ä–µ—Ç–∏–π —Å–µ–∑–æ–Ω –ø—Ä–æ—Å—Ç–æ –∫–æ—Å–º–æ—Å!",
        "–§–∏–ª–æ—Å–æ—Ñ–∏—è —Å–µ—Ä–∏–∞–ª–∞ –ø–æ—Ä–∞–∂–∞–µ—Ç",
        "–†–∏–∫ –°-137 –ª—É—á—à–∏–π –†–∏–∫!",
        "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–µ—Ä–∏—è",
        "–ü–ª–∞–∫–∞–ª –∏ —Å–º–µ—è–ª—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ",
        "–ì–ª—É–±–æ–∫–∏–π —Å–º—ã—Å–ª –∑–∞ —é–º–æ—Ä–æ–º",
        "–®–µ–¥–µ–≤—Ä –∞–Ω–∏–º–∞—Ü–∏–∏!",
        "–ü–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞—é –∏ –Ω–∞—Ö–æ–∂—É –Ω–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏",
        "–ë—Ä–∞–≤–æ —Å—Ü–µ–Ω–∞—Ä–∏—Å—Ç–∞–º!",
        "–õ—É—á—à–µ —Å –∫–∞–∂–¥—ã–º —Å–µ–∑–æ–Ω–æ–º",
    ],
    4: [
        "–ß–µ—Ç–≤—ë—Ä—Ç—ã–π —Å–µ–∑–æ–Ω –Ω–µ –ø–æ–¥–∫–∞—á–∞–ª",
        "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞—à–∫–∞–ª–∏–≤–∞–µ—Ç",
        "–†–∏–∫ –∏ –ú–æ—Ä—Ç–∏ —Ñ–æ—Ä–µ–≤–µ—Ä!",
        "–û—Ç—Å—ã–ª–∫–∏ –∫ –Ω–∞—É–∫–µ –≤–æ—Å—Ö–∏—â–∞—é—Ç",
        "–ö–∞–∂–¥–∞—è —Å–µ—Ä–∏—è - –º–∞–ª–µ–Ω—å–∫–∏–π —à–µ–¥–µ–≤—Ä",
        "–ù–µ –º–æ–≥—É –¥–æ–∂–¥–∞—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–µ–π —Å–µ—Ä–∏–∏",
        "–Æ–º–æ—Ä —Å—Ç–∞–ª –µ—â—ë –ª—É—á—à–µ",
        "–û–±–æ–∂–∞—é —ç—Ç–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π",
        "–°–µ—Ä–∏–∞–ª –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –¥—É–º–∞—Ç—å",
        "–ò–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —é–º–æ—Ä–∞ –∏ –¥—Ä–∞–º—ã",
    ],
    5: [
        "–ü—è—Ç—ã–π —Å–µ–∑–æ–Ω –ø—Ä–æ—Å—Ç–æ –æ–≥–æ–Ω—å! üî•",
        "–°—é–∂–µ—Ç–Ω—ã–µ –ª–∏–Ω–∏–∏ —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è –æ—Ç–ª–∏—á–Ω–æ",
        "–†–∏–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ",
        "–ú–æ—Ä—Ç–∏ –ø–æ–≤–∑—Ä–æ—Å–ª–µ–ª –∏ —ç—Ç–æ –≤–∏–¥–Ω–æ",
        "–°–µ–º–µ–π–Ω–∞—è –¥—Ä–∞–º–∞ + –Ω–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞ = –∏–¥–µ–∞–ª—å–Ω–æ",
        "–õ—É—á—à–∏–π —Å–µ–∑–æ–Ω –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç",
        "–ù–µ –æ–∂–∏–¥–∞–ª —Ç–∞–∫–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–æ–±—ã—Ç–∏–π",
        "–ì–µ–Ω–∏–∞–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–æ!",
        "–ü–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞—é –∏ –≤–æ—Å—Ö–∏—â–∞—é—Å—å",
        "–°–µ—Ä–∏–∞–ª –≤–µ–∫–∞!",
    ]
}

def generate_comment(season: int, episode_title: str) -> Tuple[str, str, int]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"""
    name = random.choice(NAMES)
    rating = random.choices([3, 4, 5], weights=[0.1, 0.3, 0.6])[0]
    
    templates = COMMENT_TEMPLATES.get(season, COMMENT_TEMPLATES[1])
    template = random.choice(templates)
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω –µ—Å–ª–∏ –µ—Å—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
    if '{}' in template:
        text = template.format(random.randint(2, 10) if '—Ä–∞–∑' in template else rating)
    else:
        text = template
    
    return name, text, rating

def generate_avatar(name: str) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç URL –∞–≤–∞—Ç–∞—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    from urllib.parse import quote
    seed = quote(name)
    return f"https://api.dicebear.com/7.x/fun-emoji/svg?seed={seed}&backgroundColor=06b6d4,10b981,8b5cf6,ec4899&radius=50"

def main():
    if not DATABASE_URL:
        print("ERROR: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        return
    
    conn = psycopg2.connect(DATABASE_URL)
    cur = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç–ø–∏–∑–æ–¥—ã
    cur.execute("SELECT id, title, season, episode FROM episodes ORDER BY season, episode")
    episodes = cur.fetchall()
    
    print(f"–ù–∞–π–¥–µ–Ω–æ {len(episodes)} —ç–ø–∏–∑–æ–¥–æ–≤")
    
    for ep_id, title, season, episode in episodes:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –∏ –ª–∞–π–∫–∏
        views, likes = generate_stats(season, episode)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —ç–ø–∏–∑–æ–¥
        cur.execute(
            f"UPDATE episodes SET views={views}, likes={likes} WHERE id={ep_id}"
        )
        
        print(f"–≠–ø–∏–∑–æ–¥ {season}x{episode}: {views} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, {likes} –ª–∞–π–∫–æ–≤")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–æ—Ç 30 –¥–æ 100 –Ω–∞ —ç–ø–∏–∑–æ–¥)
        num_comments = random.randint(30, 100)
        
        for _ in range(num_comments):
            name, text, rating = generate_comment(season, title)
            avatar = generate_avatar(name)
            
            # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏
            name_escaped = name.replace("'", "''")
            text_escaped = text.replace("'", "''")
            avatar_escaped = avatar.replace("'", "''")
            
            cur.execute(
                f"""INSERT INTO comments (episode_id, author_name, author_avatar, text, rating, created_at)
                VALUES ({ep_id}, '{name_escaped}', '{avatar_escaped}', '{text_escaped}', {rating}, NOW())"""
            )
        
        print(f"  –î–æ–±–∞–≤–ª–µ–Ω–æ {num_comments} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤")
    
    conn.commit()
    cur.close()
    conn.close()
    
    print("\n‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã!")

if __name__ == '__main__':
    main()
